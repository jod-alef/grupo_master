{% extends 'base.html' %}
{% load static %}
{% load template_filter %}
{% block title %}Dashboard - {{ empresa.nome }}{% endblock %}

{% block extra_head %}
<style>
    /* Design mais clean e compacto */
    .dashboard-header {
        background: linear-gradient(135deg, #4D6F54 0%, #3a5440 100%);
        color: white;
        padding: 1.25rem 0;
        margin-bottom: 1.5rem;
    }
    
    .stats-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.06);
        padding: 1rem;
        border-left: 3px solid #4D6F54;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .stats-card:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
    }
    
    .stats-number {
        font-size: 1.75rem;
        font-weight: 600;
        color: #4D6F54;
        line-height: 1;
    }
    
    .stats-label {
        color: #666;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 0.25rem;
    }
    
    .soldador-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
        margin-bottom: 1rem;
        overflow: hidden;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .soldador-card:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    .soldador-header {
        background: #f8f9fa;
        padding: 0.875rem 1rem;
        border-bottom: 1px solid #e9ecef;
    }
    
    .soldador-nome {
        font-size: 0.95rem;
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
    }
    
    .soldador-cpf {
        color: #6c757d;
        font-size: 0.8rem;
        margin-top: 0.125rem;
    }
    
    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }
    
    .btn-primary-custom {
        background: #4D6F54;
        border-color: #4D6F54;
        color: white;
        border-radius: 6px;
        font-weight: 500;
        padding: 0.5rem 1rem;
        font-size: 0.8rem;
        transition: all 0.2s ease;
    }
    
    .btn-primary-custom:hover {
        background: #3a5440;
        border-color: #3a5440;
        transform: translateY(-1px);
    }
    
    .btn-secondary-custom {
        background: white;
        border: 1px solid #4D6F54;
        color: #4D6F54;
        border-radius: 6px;
        font-weight: 500;
        padding: 0.5rem 1rem;
        font-size: 0.8rem;
        transition: all 0.2s ease;
    }
    
    .btn-secondary-custom:hover {
        background: #4D6F54;
        color: white;
        transform: translateY(-1px);
    }
    
    .company-logo {
        max-height: 60px;
        filter: brightness(0) invert(1);
    }
    
    .loading-skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: 4px;
        height: 0.75rem;
        margin: 0.25rem 0;
    }
    
    @keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    
    .section-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .section-title::before {
        content: '';
        width: 3px;
        height: 1.125rem;
        background: #4D6F54;
        border-radius: 2px;
    }
    
    .empty-state {
        text-align: center;
        padding: 2rem 1rem;
        color: #6c757d;
    }
    
    .empty-state-icon {
        font-size: 2.5rem;
        color: #dee2e6;
        margin-bottom: 0.75rem;
    }
    
    /* Estilos compactos para o header */
    .title.is-2 {
        font-size: 1.75rem !important;
    }
    
    .subtitle.is-5 {
        font-size: 1rem !important;
    }
    
    .image.is-96x96 {
        height: 60px;
        width: 60px;
    }
</style>
{% endblock %}

{% block content %}
    <!-- Header empresarial -->
    <section class="dashboard-header">
        <div class="container">
            <div class="columns is-vcentered">
                <div class="column is-narrow">
                    <figure class="image is-96x96">
                        <img src="{% static 'imgs/grupo_master.png' %}" alt="Logo" class="company-logo"/>
            </figure>
                </div>
                <div class="column">
                    <h1 class="title is-2 has-text-white mb-2">{{ empresa.nome }}</h1>
                    <p class="subtitle is-5 has-text-white-ter">Dashboard de Qualificação de Soldadores</p>
                </div>
                <div class="column is-narrow">
                    <div class="buttons">
                        <a href="{% url 'cadastro-soldador' %}" class="button btn-secondary-custom">
                            <span class="icon">
                                <i class="fas fa-user-plus"></i>
                            </span>
                            <span>Novo Soldador</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div class="container">
        <!-- Cards de estatísticas -->
        <div class="columns is-multiline mb-5">
            <div class="column is-one-quarter">
                <div class="stats-card">
                    <div class="stats-number">{{ soldadores.count }}</div>
                    <div class="stats-label">Soldadores Cadastrados</div>
                </div>
            </div>
            <div class="column is-one-quarter">
                <div class="stats-card">
                    <div class="stats-number">{{ solicitacoes.count }}</div>
                    <div class="stats-label">Solicitações Totais</div>
                </div>
            </div>
            <div class="column is-one-quarter">
                <div class="stats-card">
                    <div class="stats-number" id="aprovados-count">-</div>
                    <div class="stats-label">Aprovados</div>
                </div>
            </div>
            <div class="column is-one-quarter">
                <div class="stats-card">
                    <div class="stats-number" id="pendentes-count">-</div>
                    <div class="stats-label">Reprovados</div>
                </div>
            </div>
        </div>

        <!-- RAQS Fechados -->
        {% if raqs_fechados %}
            <div class="section-title">
                <span>RAQS Fechados - Qualificações Concluídas</span>
            </div>
            
            {% for raqs_fechado in raqs_fechados %}
                <div class="box has-background-success-light mb-4">
                    <div class="columns is-vcentered">
                        <div class="column">
                            <div class="content">
                                <p class="title is-5 mb-2">
                                    <span class="icon has-text-success">
                                        <i class="fas fa-check-circle"></i>
                                    </span>
                                    RAQS #{{ raqs_fechado.id }} - {{ raqs_fechado.n_master }}
                                </p>
                                <p class="subtitle is-6 has-text-grey mb-2">
                                    <strong>Data de Fechamento:</strong> {{ raqs_fechado.data|date:"d/m/Y" }}
                                </p>
                                <p class="has-text-grey">
                                    <strong>{{ raqs_fechado.solicitacoes.count }}</strong> {{ raqs_fechado.solicitacoes.count|pluralize_pt:"solicitação,solicitações" }} {{ raqs_fechado.solicitacoes.count|pluralize_pt:"processada,processadas" }}
                                </p>
                            </div>
                        </div>
                        <div class="column is-narrow">
                            <a href="{% url 'raqs_detail' raqs_fechado.id %}" class="button is-success btn-primary-custom">
                                <span class="icon">
                                    <i class="fas fa-eye"></i>
                                </span>
                                <span>Ver RAQS</span>
                            </a>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% endif %}

        <!-- Lista de soldadores -->
        <div class="section-title">
            <span>Soldadores e Qualificações</span>
        </div>

        {% if soldadores %}
            {% for soldador in soldadores %}
                <div class="soldador-card">
                    <div class="soldador-header">
                        <div class="columns is-vcentered is-mobile">
            <div class="column">
                                <h4 class="soldador-nome">{{ soldador.nome }}</h4>
                                <p class="soldador-cpf">CPF: {{ soldador.cpf }}</p>
                            </div>
                            <div class="column is-narrow">
                                <div class="action-buttons">
                                    <a href="{% url 'solicitacao-qualificacao-soldador' soldador.id %}" class="button btn-primary-custom is-small">
                                        <span class="icon is-small">
                                            <i class="fas fa-plus"></i>
                                        </span>
                                        <span>Nova Solicitação</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div hx-get="{% url 'solicitacoes-soldador' soldador.id %}" 
                         hx-trigger="load" 
                         hx-target="#solicitacoes-{{ soldador.id }}"
                         hx-indicator="#loading-{{ soldador.id }}">
                        <div id="loading-{{ soldador.id }}" class="px-5 py-3">
                            <div class="loading-skeleton"></div>
                            <div class="loading-skeleton" style="width: 70%;"></div>
                            <div class="loading-skeleton" style="width: 90%;"></div>
                        </div>
                        <div id="solicitacoes-{{ soldador.id }}" style="display: none;">
                            <!-- Solicitações serão carregadas aqui -->
            </div>
        </div>
    </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="fas fa-users"></i>
                </div>
                <h3 class="title is-5 has-text-grey">Nenhum soldador cadastrado</h3>
                <p class="has-text-grey-light mb-4">Comece adicionando seu primeiro soldador para gerenciar as qualificações.</p>
                <a href="{% url 'cadastro-soldador' %}" class="button btn-primary-custom">
                    <span class="icon">
                        <i class="fas fa-user-plus"></i>
                    </span>
                    <span>Cadastrar Primeiro Soldador</span>
                </a>
            </div>
        {% endif %}
    </div>

    <script>
        // Atualizar contadores quando dados carregarem
        document.addEventListener('htmx:afterSettle', function(event) {
            if (event.detail.target.id.startsWith('solicitacoes-')) {
                updateCounters();
                
                // Esconder loading e mostrar conteúdo
                const loadingEl = event.detail.target.previousElementSibling;
                const contentEl = event.detail.target;
                if (loadingEl && loadingEl.id.startsWith('loading-')) {
                    loadingEl.style.display = 'none';
                    contentEl.style.display = 'block';
                }
            }
        });

        function updateCounters() {
            let aprovados = 0;
            let pendentes = 0;
            
            document.querySelectorAll('.tag.is-success').forEach(() => aprovados++);
            document.querySelectorAll('.tag.is-warning, .tag.is-danger').forEach(() => pendentes++);
            
            document.getElementById('aprovados-count').textContent = aprovados;
            document.getElementById('pendentes-count').textContent = pendentes;
        }
    </script>
{% endblock %}